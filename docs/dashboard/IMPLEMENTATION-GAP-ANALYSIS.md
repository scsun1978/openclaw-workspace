# OpenClaw Dashboard 实施差距分析

**任务ID**: [MONITOR|GREEN|TASK_ID:DASHBOARD-IMPLEMENTATION-GAP|P1]
**版本**: v1.0
**日期**: 2026-02-18
**目标**: 基于当前系统状态与 DASHBOARD-v1-SPEC.md 规格的差距分析

---

## 1) 当前系统状态评估

### 1.1 已实现功能

| 功能模块 | 状态 | 实现程度 | 说明 |
|----------|------|----------|------|
| **基础架构** | ✅ 完成 | 100% | 后端API、前端框架、数据收集器 |
| **数据连接** | ✅ 完成 | 80% | 可读取gateway.log、cron配置、部分统计 |
| **Traces监控** | ✅ 完成 | 70% | 可查看日志条目，但缺乏深度分析 |
| **Cron监控** | ✅ 完成 | 60% | 可查看任务列表，但缺乏运行详情 |
| **Overview概览** | ✅ 部分 | 40% | 基础统计，但缺乏热力图和流水线 |
| **数据持久化** | ✅ 完成 | 100% | SQLite数据库，实时采集 |

### 1.2 数据接入状态

| 数据源 | 接入状态 | 采集频率 | 存储位置 | 备注 |
|--------|----------|----------|----------|------|
| **Gateway日志** | ✅ 已接入 | 实时 | events表 | 157条真实记录 |
| **Cron配置** | ✅ 已接入 | 30s | cron_jobs表 | 4个真实任务 |
| **Session日志** | ❌ 未接入 | - | - | 需解析workspace/*.jsonl |
| **Team-Tasks** | ⚠️  部分接入 | 30s | tasks表 | 测试数据已清理 |
| **Model统计** | ❌ 未接入 | - | - | 需skill输出或运行时解析 |
| **Memory索引** | ❌ 未接入 | - | - | 需元数据查询 |
| **Agent状态** | ❌ 未接入 | - | - | 需session列表实时查询 |

---

## 2) 与v1规格的差距分析

### 2.1 数据模型差距

#### ❌ Session 模型
**规格要求**:
```typescript
interface Session {
  id: string;
  agentId: string;
  channel: string;
  status: 'active' | 'idle' | 'error' | 'closed';
  contextTokens: number;
  model: string;
  messageCount: number;
  errorCount: number;
  cost: number;
}
```

**当前状态**: 未实现
- 缺少对 `workspace/*.jsonl` 的解析
- 缺少成本计算逻辑
- 缺少状态分类

**实施优先级**: **P0** (基础数据源)

#### ❌ Task 模型
**规格要求**:
```typescript
interface Task {
  id: string;
  project: string;
  stage: string;
  owner: string;
  status: 'pending' | 'in-progress' | 'done' | 'failed' | 'blocked';
  stalledMinutes: number;
  pushAttempts: number;
  deadline: timestamp;
}
```

**当前状态**: 部分实现
- 可读取 team-tasks JSON
- 缺少停滞检测逻辑
- 缺少deadline追踪
- 缺少推送机制

**实施优先级**: **P0** (已有基础，需增强)

#### ❌ Alert 模型
**规格要求**:
```typescript
interface Alert {
  id: string;
  type: 'stall' | 'error' | 'cost' | 'debt' | 'gate';
  severity: 'P0' | 'P1' | 'P2';
  escalateTo: string | null;
}
```

**当前状态**: 未实现
- alerts表为空
- 缺少告警规则引擎
- 缺少升级逻辑

**实施优先级**: **P1** (依赖Session和Task数据)

#### ❌ Metric 模型
**规格要求**:
```typescript
interface Metric {
  type: 'token' | 'cost' | 'latency' | 'error_rate' | 'coverage';
  agentId: string;
  model: string;
  value: number;
  tags: Record<string, string>;
}
```

**当前状态**: 未实现
- 缺少时序数据存储
- 缺少指标聚合计算
- 缺少成本解析

**实施优先级**: **P1** (需要实时数据采集)

#### ❌ Debt 模型
**规格要求**:
```typescript
interface Debt {
  id: string;
  source: string;  // W1/W2/W3
  status: 'open' | 'in-progress' | 'closed';
  priority: 'P0' | 'P1' | 'P2';
  dueDate: timestamp | null;
}
```

**当前状态**: 未实现
- 缺少风险卡数据源
- 缺少状态跟踪
- 缺少逾期检测

**实施优先级**: **P2** (需要风险卡数据)

### 2.2 页面功能差距

#### ❌ P1 概览页
**规格要求**:
- 系统健康度指示器 (GREEN/YELLOW/RED)
- Agent活跃度热力图
- 任务流水线状态
- 最近告警TOP 5

**当前状态**: 40%实现
- ✅ 基础统计展示
- ❌ 缺少健康度指标
- ❌ 缺少热力图
- ❌ 缺少流水线可视化

**实施优先级**: **P1** (核心页面)

#### ❌ P2 Agent监控页
**规格要求**:
- Agent选择器
- 活跃会话统计
- 上下文占用率
- 模型调用分布
- 最近会话列表

**当前状态**: 20%实现
- ✅ Agent列表（基础）
- ❌ 缺少会话详情
- ❌ 缺少模型统计
- ❌ 缺少成本追踪

**实施优先级**: **P1** (核心监控)

#### ❌ P3 任务看板页
**规格要求**:
- Kanban视图 (Pending/Active/Done)
- 停滞任务详情
- 项目筛选
- 阶段筛选

**当前状态**: 10%实现
- ✅ 基础列表视图
- ❌ 缺少Kanban布局
- ❌ 缺少停滞检测
- ❌ 缺少推送功能

**实施优先级**: **P1** (协作治理)

#### ❌ P4 告警中心页
**规格要求**:
- 告警列表
- 严重程度筛选
- 升级操作
- 确认操作

**当前状态**: 5%实现
- ✅ 基础页面框架
- ❌ 无告警数据
- ❌ 无处理操作

**实施优先级**: **P1** (问题发现)

#### ❌ P5 技术债务页
**规格要求**:
- 债务看板
- 趋势图
- 优先级排序
- 状态跟踪

**当前状态**: 未实现
- ❌ 无债务数据源
- ❌ 无看板界面

**实施优先级**: **P2** (需要风险卡数据)

#### ❌ P6 分析报表页
**规格要求**:
- 成本趋势图
- 效率对比
- 模型分布
- Fallback分析

**当前状态**: 未实现
- ❌ 无历史数据积累
- ❌ 无分析计算

**实施优先级**: **P2** (需要数据积累)

### 2.3 告警规则差距

| 规则类型 | 当前状态 | 差距 |
|----------|----------|------|
| **任务停滞告警** | ❌ 未实现 | 缺少停滞检测逻辑、推送机制 |
| **错误率告警** | ❌ 未实现 | 缺少错误率计算、阈值判断 |
| **成本告警** | ❌ 未实现 | 缺少成本解析、日/时累计 |
| **技术债务告警** | ❌ 未实现 | 缺少风险卡数据、逾期检测 |
| **Gate结论告警** | ❌ 未实现 | 缺少gate状态解析、NO-GO检测 |
| **模型Fallback告警** | ❌ 未实现 | 缺少fallback事件统计、频率分析 |

**实施优先级**: **P1** (依赖数据模型完善)

---

## 3) 下一步行动计划

### Phase 1: 数据源完善 (Week 1)

**目标**: 建立完整的数据采集能力

#### 任务1.1: Session日志采集 ⭐⭐⭐
```bash
优先级: P0
工作量: 3天
负责人: Backend开发
```
**内容**:
- 解析 `~/.openclaw/workspace/*/*.jsonl` 文件
- 提取session元数据: agentId, channel, createdAt
- 实时统计消息数、错误数
- 计算 contextTokens (基于消息大小估算)
- 解析model字段 (从响应或配置)

**验收标准**:
- 可展示所有活跃session
- 实时更新session状态
- 正确计算token使用量

#### 任务1.2: Model统计采集 ⭐⭐
```bash
优先级: P1
工作量: 2天
负责人: Backend + Skill开发
```
**内容**:
- 扩展model-observer skill或创建新skill
- 输出统计到标准化格式
- 集成到collector采集流程

**验收标准**:
- 可展示各模型调用量
- 可统计fallback次数
- 可计算token成本

#### 任务1.3: Agent状态实时监控 ⭐⭐⭐
```bash
优先级: P0
工作量: 2天
负责人: Backend开发
```
**内容**:
- 通过OpenClaw gateway API获取session列表
- 实时监控session状态变化
- 检测blocked/idle状态

**验收标准**:
- 实时显示活跃session数
- 准确反映session状态变化

### Phase 2: 核心功能开发 (Week 2-3)

#### 任务2.1: 概览页开发 ⭐⭐⭐
```bash
优先级: P1
工作量: 3天
负责人: Frontend + Backend
```
**内容**:
- 实现系统健康度计算逻辑
- 创建Agent热力图组件
- 集成任务流水线状态展示
- 实现最近告警TOP5列表

**验收标准**:
- 一屏看全系统状态
- 热力图实时更新
- 健康度指标准确

#### 任务2.2: Agent监控页开发 ⭐⭐⭐
```bash
优先级: P1
工作量: 4天
负责人: Frontend + Backend
```
**内容**:
- Agent选择器组件
- 会话列表展示
- 上下文占用率计算
- 模型分布图
- 成本统计展示

**验收标准**:
- 可切换查看不同Agent
- 会话详情可展开
- 模型数据可视化

#### 任务2.3: 任务看板页开发 ⭐⭐⭐
```bash
优先级: P1
工作量: 4天
负责人: Frontend + Backend
```
**内容**:
- 实现Kanban布局 (Pending/Active/Done)
- 停滞检测算法集成
- 任务详情侧边栏
- 推送提醒功能

**验收标准**:
- 拖拽交互流畅
- 停滞任务高亮
- 推送功能正常

### Phase 3: 告警系统 (Week 3)

#### 任务3.1: 告警引擎开发 ⭐⭐⭐
```bash
优先级: P1
工作量: 5天
负责人: Backend开发
```
**内容**:
- 实现6类告警规则
- 告警去重和聚合
- 严重程度判断逻辑
- 升级机制

**验收标准**:
- 6类告警全部生效
- 告警准确率高
- 误报率低

#### 任务3.2: 告警中心页开发 ⭐⭐
```bash
优先级: P1
工作量: 3天
负责人: Frontend
```
**内容**:
- 告警列表展示
- 筛选和排序功能
- 确认/升级操作
- 告警处理历史

**验收标准**:
- 告警实时更新
- 操作响应及时
- 用户体验流畅

### Phase 4: 高级功能 (Week 4)

#### 任务4.1: 技术债务页开发 ⭐⭐
```bash
优先级: P2
工作量: 3天
负责人: Frontend
```
**依赖**: 需要风险卡数据源

#### 任务4.2: 分析报表页开发 ⭐⭐
```bash
优先级: P2
工作量: 4天
负责人: Frontend + Backend
```

#### 任务4.3: 运维调优页开发 ⭐⭐
```bash
优先级: P2
工作量: 3天
负责人: Frontend + Backend
```

---

## 4) 技术架构优化建议

### 4.1 数据流优化

**当前问题**: 数据采集分散，缺乏统一管理

**建议方案**:
```
┌─────────────────────────────────────────────────────┐
│  Data Collection Layer (Collector)                    │
│  - Gateway日志 → Session事件                         │
│  - Workspace解析 → Task更新                         │
│  - Model统计 → Metric记录                           │
│  - Gateway API → Agent状态                           │
└─────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────┐
│  Data Processing Layer (Engine)                       │
│  - 告警规则引擎                                      │
│  - 停滞检测算法                                      │
│  - 成本计算逻辑                                      │
│  - 健康度评分                                        │
└─────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────┐
│  Data Storage Layer (Database)                       │
│  - 时序数据 (metrics)                                │
│  - 状态数据 (sessions, tasks, agents)                │
│  - 告警历史 (alerts)                                │
└─────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────┐
│  API Layer (Backend)                                 │
│  - RESTful APIs                                      │
│  - WebSocket推送                                     │
│  - GraphQL (可选)                                    │
└─────────────────────────────────────────────────────┘
                          ↓
┌─────────────────────────────────────────────────────┐
│  Presentation Layer (Frontend)                        │
│  - React组件                                        │
│  - 实时更新                                          │
│  - 可视化图表                                        │
└─────────────────────────────────────────────────────┘
```

### 4.2 实时性优化

**当前**: 30秒轮询采集
**目标**: 事件驱动更新

**实施步骤**:
1. Phase 1: 保持30秒采集，优化数据处理
2. Phase 2: 对关键数据实现WebSocket推送
3. Phase 3: 全量切换到事件驱动

### 4.3 可扩展性设计

**建议**:
- 插件化告警规则引擎
- 模块化数据采集器
- 可配置的Dashboard布局

---

## 5) 里程碑与验收标准

### Milestone 1: 数据源完善 (Week 1 End)
**验收**:
- ✅ Session数据完整采集
- ✅ Model统计数据可用
- ✅ Agent状态实时可见
- ✅ API响应时间 < 500ms

### Milestone 2: 核心功能上线 (Week 3 End)
**验收**:
- ✅ Overview页面一屏看全
- ✅ Agent监控页数据完整
- ✅ 任务看板功能正常
- ✅ 告警中心接收告警

### Milestone 3: 系统完整交付 (Week 4 End)
**验收**:
- ✅ 所有6个页面功能正常
- ✅ 6类告警规则生效
- ✅ 实时更新 < 5秒延迟
- ✅ 文档完整，可交付

---

## 6) 风险与缓解措施

| 风险 | 影响 | 概率 | 缓解措施 |
|------|------|------|----------|
| **数据源不稳定** | 无法获取某些类型数据 | 中 | 实现fallback机制，降级展示 |
| **性能瓶颈** | 实时更新延迟 | 中 | 数据预处理、分页加载 |
| **告警误报** | 用户不信任告警 | 高 | 调优阈值、增加确认机制 |
| **开发资源不足** | 无法按时完成 | 低 | 分优先级，MVP优先 |

---

## 7) 下一步行动

### 立即行动 (本周)
1. **启动Session日志采集** - 解析workspace jsonl文件
2. **实现Agent状态监控** - 通过gateway API
3. **概览页原型设计** - 基于现有框架

### 本周目标
- 完成Session和Agent状态数据采集
- 概览页原型可用
- 制定详细技术设计方案

### 需求确认
请确认以下优先级排序：
1. 是否优先实现数据采集 (Session + Agent)？
2. 概览页设计是否需要先进行原型评审？
3. 是否需要并行进行其他模块开发？

---

**状态**: 待用户确认优先级后开始Phase 1开发